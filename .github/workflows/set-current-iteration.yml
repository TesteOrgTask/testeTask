name: Set current iteration (Projects v2)

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number para testar manualmente"
        required: false
        type: string

jobs:
  set-iteration:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      contents: read
    env:
      # PAT classic com: project, read:org (+ repo se o repo for privado)
      GH_TOKEN: ${{ secrets.PROJECTS_TOKEN }}

      # IDs fixos do seu Project/Iteration
      PROJECT_ID: PVT_kwDODkGqB84BGE05
      FIELD_ID: PVTIF_lADODkGqB84BGE05zg3XHl0

    steps:
      - name: Sanity / whoami
        shell: bash
        run: |
          gh --version
          echo "GH_TOKEN length: ${#GH_TOKEN}"
          gh api user

      - name: Resolver ISSUE_NODE_ID (evento ou manual)
        id: issue
        shell: bash
        run: |
          if [ -n "${{ inputs.issue_number }}" ]; then
            NUM="${{ inputs.issue_number }}"
          else
            NUM="${{ github.event.issue.number }}"
          fi
          if [ -z "$NUM" ]; then
            echo "Nenhum issue_number disponível. Abra via 'issues: opened' ou use workflow_dispatch com issue_number." >&2
            exit 1
          fi
          echo "ISSUE_NUMBER=$NUM" >> $GITHUB_ENV
          NODE_ID=$(gh api repos/${{ github.repository }}/issues/$NUM -q .node_id)
          if [ -z "$NODE_ID" ]; then
            echo "Não consegui obter node_id da issue #$NUM em ${{ github.repository }}." >&2
            exit 1
          fi
          echo "ISSUE_NODE_ID=$NODE_ID" >> $GITHUB_ENV
          echo "node_id=$NODE_ID"

      - name: Adicionar item ao Project (idempotente)
        id: additem
        shell: bash
        run: |
          # 1) mutation para adicionar conteúdo ao Project (não falha se já existir)
          cat > add.graphql <<'GRAPHQL'
          mutation($project:ID!, $content:ID!){
            addProjectV2ItemById(input:{projectId:$project, contentId:$content}) {
              item { id }
            }
          }
          GRAPHQL
          gh api graphql -f query=@add.graphql -f project="$PROJECT_ID" -f content="$ISSUE_NODE_ID" > add.json || true
          echo "add.json:"; cat add.json || true

          # 2) buscar o ITEM_ID dessa issue dentro do Project
          cat > find_item.graphql <<'GRAPHQL'
          query($project:ID!, $issue:String!) {
            node(id:$project) {
              ... on ProjectV2 {
                items(first:100, query:$issue) { nodes { id } }
              }
            }
          }
          GRAPHQL
          ITEM_ID=$(gh api graphql -f query=@find_item.graphql -f project="$PROJECT_ID" -f issue="$ISSUE_NODE_ID" -q .data.node.items.nodes[0].id)
          if [ -z "$ITEM_ID" ]; then
            echo "Item não encontrado no Project. Verifique permissões do token/acesso ao Project." >&2
            exit 1
          fi
          echo "ITEM_ID=$ITEM_ID" >> $GITHUB_ENV
          echo "item_id=$ITEM_ID"

      - name: Obter config do campo Iteration
        id: getfield
        shell: bash
        run: |
          cat > fields.graphql <<'GRAPHQL'
          query($project:ID!){
            node(id:$project){
              ... on ProjectV2 {
                fields(first:50){
                  nodes{
                    __typename
                    ... on ProjectV2IterationField {
                      id name
                      configuration { iterations { id title startDate duration } }
                    }
                  }
                }
              }
            }
          }
          GRAPHQL
          gh api graphql -f query=@fields.graphql -f project="$PROJECT_ID" > project_fields.json
          echo "TODAY=$(TZ=America/Sao_Paulo date +%F)" >> $GITHUB_ENV
          echo "today=$(TZ=America/Sao_Paulo date +%F)"

      - name: Calcular iterationId atual (São Paulo)
        id: pickiter
        shell: bash
        run: |
          python3 - <<'PY'
          import json, os, sys
          from datetime import date, timedelta

          today_str = os.environ.get("TODAY")
          if not today_str:
              print("Sem TODAY no env", file=sys.stderr)
              sys.exit(1)
          today = date.fromisoformat(today_str)

          with open("project_fields.json", "r", encoding="utf-8") as f:
              data = json.load(f)

          fields = data["data"]["node"]["fields"]["nodes"]
          FIELD_ID = os.environ["FIELD_ID"]

          iter_field = None
          for f in fields:
              if f.get("__typename") == "ProjectV2IterationField" and f.get("id") == FIELD_ID:
                  iter_field = f
                  break

          if not iter_field:
              print("Campo Iteration não encontrado pelo FIELD_ID fornecido.", file=sys.stderr)
              sys.exit(1)

          iterations = (iter_field.get("configuration") or {}).get("iterations") or []
          current = None
          for it in iterations:
              sd = it.get("startDate")
              dur = it.get("duration")
              if not sd or not dur:
                  continue
              start = date.fromisoformat(sd)
              end = start + timedelta(days=int(dur))
              if start <= today < end:
                  current = it["id"]
                  break

          if not current:
              print("Nenhuma iteração atual encontrada (confira startDate/duration no campo Iteration).", file=sys.stderr)
              sys.exit(1)

          print(f"ITERATION_ID={current}")
          PY
          | tee iter.env

          # exportar var para próximos passos
          source iter.env
          echo "ITERATION_ID=$ITERATION_ID" >> $GITHUB_ENV

      - name: Aplicar Iteration = current
        shell: bash
        run: |
          cat > update_iter.graphql <<'GRAPHQL'
          mutation($project:ID!, $item:ID!, $field:ID!, $iter:String!){
            updateProjectV2ItemFieldValue(
              input:{projectId:$project, itemId:$item, fieldId:$field, value:{iterationId:$iter}}
            ){ clientMutationId }
          }
          GRAPHQL

          gh api graphql -f query=@update_iter.graphql \
            -f project="$PROJECT_ID" \
            -f item="$ITEM_ID" \
            -f field="$FIELD_ID" \
            -f iter="$ITERATION_ID"

          echo "✅ Iteration aplicada."