name: Add PR to Project and Assign

on:
  pull_request:
    types: [opened, reopened]

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    steps:
      - name: Add PR to Project v2 and assign
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECTS_TOKEN }}
          script: |
            const projectId = "PVT_kwDODkGqB84BGE05"; // ID do seu Project
            const assigneeLogin = "AmorimAntonio"; // GitHub username a ser atribuído

            // 1️⃣ Adiciona o PR ao Project
            const addItem = await github.graphql(
              `
              mutation($projectId: ID!, $prId: ID!) {
                addProjectV2ItemById(input: {projectId: $projectId, contentId: $prId}) {
                  item {
                    id
                  }
                }
              }
              `,
              {
                projectId,
                prId: context.payload.pull_request.node_id,
              }
            );

            const itemId = addItem.addProjectV2ItemById.item.id;

            // 2️⃣ Pega o campo "Assignees" do seu Project (você precisa descobrir o ID dele uma vez)
            const fields = await github.graphql(`
              query {
                node(id: "${projectId}") {
                  ... on ProjectV2 {
                    fields(first: 20) {
                      nodes {
                        id
                        name
                      }
                    }
                  }
                }
              }
            `);

            const assigneeField = fields.node.fields.nodes.find(f => f.name === "Assignees");
            if (!assigneeField) {
              core.warning("Campo 'Assignees' não encontrado no Project.");
              return;
            }

            // 3️⃣ Busca o ID do usuário pelo login
            const user = await github.graphql(
              `
              query($login: String!) {
                user(login: $login) {
                  id
                }
              }
              `,
              { login: assigneeLogin }
            );

            const userId = user.user.id;

            // 4️⃣ Define o assignee no campo correspondente
            await github.graphql(
              `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $userId: ID!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { 
                      users: [ $userId ] 
                    }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
              `,
              { projectId, itemId, fieldId: assigneeField.id, userId }
            );

            console.log(`✅ PR adicionado ao Project e atribuído a ${assigneeLogin}`);