name: Add PR to Project and set ToDo + Assign

on:
  pull_request:
    types: [opened, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write
  repository-projects: write

jobs:
  add-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Add PR to Project v2, set To Do, and assign
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECTS_TOKEN }}
          script: |
            const projectId = process.env.PROJECT_ID;
            const assignees = process.env.ASSIGNEES.split(',').map(a => a.trim());

            // 1️⃣ Adiciona o PR ao Project
            const add = await github.graphql(
              `mutation($projectId: ID!, $contentId: ID!) {
                 addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                   item { id }
                 }
               }`,
              { projectId, contentId: context.payload.pull_request.node_id }
            );
            const itemId = add.addProjectV2ItemById.item.id;

            // 2️⃣ Busca campo "Status" e ID da opção "To Do"
            const fields = await github.graphql(
              `query($projectId: ID!) {
                 node(id: $projectId) {
                   ... on ProjectV2 {
                     fields(first: 50) {
                       nodes {
                         ... on ProjectV2SingleSelectField {
                           id
                           name
                           options { id name }
                         }
                       }
                     }
                   }
                 }
               }`,
              { projectId }
            );

            const statusField = fields.node.fields.nodes.find(f => f.name === "Status");
            const todoOption = statusField?.options?.find(o => o.name.toLowerCase() === "todo");
            if (statusField && todoOption) {
              await github.graphql(
                `mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                   updateProjectV2ItemFieldValue(input: {
                     projectId: $projectId
                     itemId: $itemId
                     fieldId: $fieldId
                     value: { singleSelectOptionId: $optionId }
                   }) { projectV2Item { id } }
                 }`,
                {
                  projectId,
                  itemId,
                  fieldId: statusField.id,
                  optionId: todoOption.id
                }
              );
            } else {
              core.warning('Campo "Status" ou opção "To Do" não encontrados.');
            }

            // 3️⃣ Atribui usuários no PR (Project espelha)
            if (assignees.length) {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                assignees
              });
            }
        env:
          PROJECT_ID: PVT_kwDODkGqB84BGE05    # <-- ID do seu Project
          ASSIGNEES: AmorimAntonio              # <-- logins separados por vírgula
